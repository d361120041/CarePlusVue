<template>
  <div class="wrapper">
    <!-- ğŸ”™ è¿”å›æŒ‰éˆ• -->
    <button
      @click="goBack"
      class="back-button flex items-center text-teal-600 hover:text-teal-700 transition-colors duration-200"
      aria-label="è¿”å›é ç´„é é¢"
    >
      <svg
        class="w-5 h-5 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"
        ></path>
      </svg>
      è¿”å›
    </button>

    <!-- ğŸ“‹ è¨‚å–®è³‡è¨Šå€å¡Š -->
    <div class="card-section mb-8">
      <h2 class="section-title">è¨‚å–®è³‡è¨Š</h2>
      <div v-if="appointment" class="info-grid">
        <!-- è¨‚å–®è™Ÿç¢¼ -->
        <div class="info-item">
          <span class="label">è¨‚å–®è™Ÿç¢¼</span>
          <span class="value">
            {{
              appointment.appointmentId
                ? `carePlus0522id${appointment.appointmentId}`
                : "æœªæä¾›"
            }}
          </span>
        </div>

        <!-- ç¸½é‡‘é¡ -->
        <div class="info-item">
          <span class="label">ç¸½é‡‘é¡</span>
          <span class="value">
            {{
              appointment.totalPrice
                ? `${appointment.totalPrice} å…ƒ`
                : "è¨ˆç®—ä¸­..."
            }}
          </span>
        </div>
      </div>
      <div v-else class="loading-state text-center py-12">
        <div
          class="animate-spin inline-block w-8 h-8 border-4 border-teal-600 border-t-transparent rounded-full"
        ></div>
        <p class="mt-4 text-lg text-gray-600">æ­£åœ¨è¼‰å…¥è¨‚å–®è³‡è¨Š...</p>
      </div>
    </div>

    <!-- ğŸ“œ åˆç´„å…§å®¹å€å¡Š -->
    <div class="card-section mb-8">
      <h2 class="section-title">ç…§è­·æœå‹™æ¥å—é ˆçŸ¥</h2>
      <div class="contract-content bg-gray-50 p-6 rounded-lg max-h-96 overflow-y-auto">
        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">
          ç…§è­·æœå‹™æ¥å—é ˆçŸ¥

          ä¸€ã€æœå‹™å…§å®¹
          ç…§è­·å“¡éœ€æ ¹æ“šé¡§å®¢æä¾›çš„éœ€æ±‚å–®ï¼Œæä¾›å€‹äººè¡›ç”Ÿå”åŠ©ã€æ—¥å¸¸ç”Ÿæ´»ç…§è­·ã€å¥åº·ç›£æ¸¬ç­‰ç›¸é—œæœå‹™ã€‚
          ç…§è­·å“¡éœ€ç†Ÿæ‚‰é¡§å®¢çš„èº«é«”ç‹€æ³ã€ç–¾ç—…å²åŠç‰¹æ®Šéœ€æ±‚ï¼Œä¸¦ç¢ºä¿æœå‹™è³ªé‡ã€‚

          äºŒã€æœå‹™æº–å‚™
          ç¢ºä¿æœå‹™é–‹å§‹å‰å·²å……åˆ†äº†è§£é¡§å®¢éœ€æ±‚ä¸¦æº–å‚™å¿…è¦çš„è­·ç†å·¥å…·ã€‚
          ç¢ºèªæœå‹™åœ°é»æ˜¯å¦å®‰å…¨ä¸¦ç¬¦åˆè¡›ç”Ÿæ¨™æº–ã€‚

          ä¸‰ã€æœå‹™æ…‹åº¦
          å§‹çµ‚ä¿æŒå°ˆæ¥­ã€è€å¿ƒå’Œé—œæ„›çš„æ…‹åº¦ï¼Œå°Šé‡é¡§å®¢éš±ç§ã€‚
          åš´ç¦é€éœ²é¡§å®¢çš„å€‹äººè³‡è¨Šæˆ–å¥åº·ç‹€æ³çµ¦ç¬¬ä¸‰æ–¹ã€‚
          å¦‚é¡§å®¢æœ‰ç‰¹åˆ¥æŒ‡ç¤ºï¼Œéœ€ç›¡é‡æ»¿è¶³ä¸¦è€å¿ƒè§£é‡‹æœå‹™å…§å®¹ã€‚

          å››ã€æœå‹™æœŸé–“
          æº–æ™‚æŠµé”æœå‹™åœ°é»ï¼ŒæŒ‰æ™‚æä¾›æœå‹™ï¼Œä¸¦é¿å…ç„¡æ•…é²åˆ°æˆ–æ—©é€€ã€‚
          è‹¥ç™¼ç¾é¡§å®¢èº«é«”ç•°å¸¸ï¼Œæ‡‰ç«‹å³é€šçŸ¥å…¶å®¶å±¬æˆ–è² è²¬é†«ç™‚å–®ä½ã€‚
          ç¦æ­¢åœ¨æœå‹™æœŸé–“é€²è¡Œä»»ä½•èˆ‡æœå‹™ç„¡é—œçš„æ´»å‹•ï¼ŒåŒ…æ‹¬ç§äººé€šè©±æˆ–è§€çœ‹å½±ç‰‡ã€‚

          äº”ã€æœå‹™è®Šæ›´èˆ‡å–æ¶ˆ
          è‹¥éœ€æ›´æ”¹æˆ–å–æ¶ˆæœå‹™ï¼Œæ‡‰è‡³å°‘æå‰24å°æ™‚é€šçŸ¥å¹³å°æˆ–é¡§å®¢ã€‚
          æœªç¶“é¡§å®¢åŒæ„ï¼Œä¸å¾—æå‰çµæŸæœå‹™æˆ–æ“…è‡ªæ”¹è®Šæœå‹™å…§å®¹ã€‚

          å…­ã€å®‰å…¨èˆ‡è²¬ä»»
          ç…§è­·å“¡æ‡‰å°æœå‹™æœŸé–“é¡§å®¢çš„å®‰å…¨è² è²¬ï¼Œé¿å…ç™¼ç”Ÿæ„å¤–æˆ–äººèº«å‚·å®³ã€‚
          ç¦æ­¢é€²è¡Œä»»ä½•å¯èƒ½å±å®³é¡§å®¢å¥åº·æˆ–å®‰å…¨çš„è¡Œç‚ºã€‚
          è‹¥ç™¼ç”Ÿæ„å¤–ï¼Œéœ€ç«‹å³å‘å¹³å°å ±å‘Šä¸¦å”åŠ©è™•ç†ç›¸é—œäº‹å®œã€‚

          ä¸ƒã€è²»ç”¨èˆ‡ä»˜æ¬¾
          æœå‹™è²»ç”¨å°‡æ ¹æ“šå¹³å°è¨­å®šæ¨™æº–è¨ˆç®—ï¼Œä¸¦åœ¨é¡§å®¢ä»˜æ¬¾å¾Œçµ±ä¸€çµç®—ã€‚
          ç¦æ­¢å‘é¡§å®¢ç§ä¸‹æ”¶å–é¡å¤–è²»ç”¨æˆ–è¦æ±‚é¡å¤–å ±é…¬ã€‚

          å…«ã€é•è¦è™•ç†
          è‹¥ç™¼ç¾æœå‹™æ…‹åº¦ä¸ä½³ã€é•åå¹³å°è¦å®šæˆ–æ¶‰åŠé•æ³•è¡Œç‚ºï¼Œå¹³å°æœ‰æ¬Šçµ‚æ­¢åˆä½œã€‚
          åš´é‡é•è¦è€…å°‡è¢«åˆ—å…¥å¹³å°é»‘åå–®ï¼Œä¸¦è¦–æƒ…æ³æ¡å–æ³•å¾‹è¡Œå‹•ã€‚
        </p>
      </div>

      <!-- å‹¾é¸æ¡†èˆ‡ç¢ºèªæŒ‰éˆ• -->
      <div class="mt-6 flex items-center">
        <input
          type="checkbox"
          v-model="isContractConfirmed"
          id="contract-checkbox"
          class="h-5 w-5 text-teal-600 rounded focus:ring-teal-500"
        />
        <label for="contract-checkbox" class="ml-2 text-gray-700 font-medium">
          æˆ‘å·²é–±è®€ä¸¦åŒæ„ä»¥ä¸Šåˆç´„å…§å®¹
        </label>
      </div>
    </div>

    <!-- ğŸ’³ ä»˜æ¬¾æŒ‰éˆ• -->
    <div class="card-section">
      <h2 class="section-title">ä»˜æ¬¾</h2>
      <p class="text-gray-600 mb-4">è«‹ç¢ºèªè¨‚å–®è³‡è¨Šå¾Œé€²è¡Œä»˜æ¬¾ã€‚</p>
      <button
        @click="proceedToPayment"
        :disabled="!appointment"
        class="payment-button w-full flex justify-center items-center py-3 rounded-full font-medium transition-all duration-200 transform hover:scale-105"
        :class="
          appointment
            ? 'bg-green-600 text-white hover:bg-green-700'
            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
        "
        aria-label="å‰å¾€ä»˜æ¬¾"
      >
        å‰å¾€ç¶ ç•Œæ”¯ä»˜
      </button>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from "vue";
import { useRouter } from "vue-router";
import myAxios from "@/plugins/axios";
import Swal from "sweetalert2";

const router = useRouter();
const appointment = ref(null);
const isContractConfirmed = ref(false);

onMounted(async () => {
  const appointmentId = localStorage.getItem("appointmentId");
  console.log("å¾ localStorage å–å¾—çš„ appointmentId:", appointmentId);

  if (!appointmentId) {
    Swal.fire({
      title: "éŒ¯èª¤",
      text: "ç„¡æ³•æ‰¾åˆ°é ç´„ IDï¼Œè«‹é‡æ–°é€²å…¥é ç´„æµç¨‹ã€‚",
      icon: "error",
      confirmButtonText: "ç¢ºå®š",
    });
    router.push("/");
    return;
  }

  try {
    // å–å¾— Appointment åŸºæœ¬è³‡æ–™
    const response = await myAxios.get(`/api/appointment/${appointmentId}`);
    const data = response.data;
    console.log("Appointment data:", data);

    // è¨­å®š Appointment è³‡æ–™
    appointment.value = {
      appointmentId: data.appointmentId,
      totalPrice: data.totalPrice,
    };
  } catch (error) {
    console.error("Failed to fetch appointment details:", error);
    Swal.fire({
      title: "éŒ¯èª¤",
      text: "ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡è¨Šï¼Œè«‹ç¨å¾Œå†è©¦ï¼",
      icon: "error",
      confirmButtonText: "ç¢ºå®š",
    });
  }
});

const confirmContract = async () => {
  if (!isContractConfirmed.value) {
    Swal.fire({
      title: 'æç¤º',
      text: 'è«‹å‹¾é¸åŒæ„åˆç´„å…§å®¹ï¼',
      icon: 'warning',
      confirmButtonText: 'ç¢ºå®š',
    });
    return;
  }

  try {
    const appointmentId = appointment.value.id;
    const response = await myAxios.put(`/api/appointment/${appointmentId}/contract`);
    appointment.value = response.data; // æ›´æ–°æœ¬åœ°é ç´„è³‡æ–™
    appointmentStore.setAppointment(response.data); // æ›´æ–° Pinia Store
    Swal.fire({
      title: 'æˆåŠŸ',
      text: 'åˆç´„å·²ç¢ºèªï¼',
      icon: 'success',
      confirmButtonText: 'ç¢ºå®š',
    });
  } catch (error) {
    console.error('Failed to confirm contract:', error);
    Swal.fire({
      title: 'éŒ¯èª¤',
      text: 'åˆç´„ç¢ºèªå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼',
      icon: 'error',
      confirmButtonText: 'ç¢ºå®š',
    });
  }
};


const proceedToPayment = async () => {
  try {
    // âœ… ç¢ºä¿å·²å¾ localStorage å–å¾— appointmentId
    const appointmentId = appointment.value?.appointmentId || localStorage.getItem("appointmentId");

    if (!appointmentId) {
      Swal.fire({
        title: "éŒ¯èª¤",
        text: "ç„¡æ³•æ‰¾åˆ°é ç´„ IDï¼Œè«‹é‡æ–°é€²å…¥é ç´„æµç¨‹ã€‚",
        icon: "error",
        confirmButtonText: "ç¢ºå®š",
      });
      router.push("/");
      return;
    }

    // ç™¼é€æ”¯ä»˜è«‹æ±‚
    const response = await myAxios.get(`/payment/ecpay`, {
      params: { appointmentId },
    });

    // ç›´æ¥å°‡å›å‚³çš„è¡¨å–®æ³¨å…¥é é¢
    document.write(response.data);

    // âœ… æ¸…ç©º localStorage
    localStorage.removeItem("appointmentData");
    localStorage.removeItem("appointmentId");
    localStorage.removeItem("caregiverId");
    localStorage.removeItem("continuousEndDate");
    localStorage.removeItem("continuousEndTime");
    localStorage.removeItem("continuousStartDate");
    localStorage.removeItem("continuousStartTime");
    localStorage.removeItem("timeType");
    

    console.log("LocalStorage æ¸…ç©ºå®Œæˆ");

  } catch (error) {
    console.error("Failed to proceed to payment:", error);
    Swal.fire({
      title: "éŒ¯èª¤",
      text: "ç„¡æ³•åˆå§‹åŒ–æ”¯ä»˜ï¼Œè«‹ç¨å¾Œå†è©¦ï¼",
      icon: "error",
      confirmButtonText: "ç¢ºå®š",
    });
  }
};

const goBack = () => {
  router.push("/appointments");
};
</script>

<style scoped>
.wrapper {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

.card-section {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
  padding: 2.5rem;
  transition: transform 0.3s ease;
}

.card-section:hover {
  transform: translateY(-4px);
}

.back-button {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1rem;
  font-size: 1rem;
  font-weight: 500;
  color: #1f2937;
  background-color: #e5f4f5;
  border-radius: 8px;
  border: 1px solid #b0e0e6;
  margin-bottom: 1.5rem;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.back-button:hover {
  background-color: #d1ecee;
  color: #0f766e;
  transform: translateX(-2px);
}

.back-button svg {
  transition: transform 0.2s ease;
}

.back-button:hover svg {
  transform: translateX(-3px);
}

.section-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 1.5rem;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.info-item {
  display: flex;
  flex-direction: column;
}

.label {
  font-size: 0.875rem;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.value {
  font-size: 1rem;
  color: #1f2937;
  margin-top: 0.25rem;
}

.contract-content {
  border: 1px solid #e5e7eb;
  font-size: 0.95rem;
}

.payment-button {
  background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
}

.payment-button:hover:enabled {
  background: linear-gradient(135deg, #15803d 0%, #166534 100%);
}

.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
}

@media (max-width: 768px) {
  .wrapper {
    padding: 1.5rem 1rem;
  }

  .card-section {
    padding: 1.5rem;
  }

  .info-grid {
    grid-template-columns: 1fr;
  }
}
</style>
